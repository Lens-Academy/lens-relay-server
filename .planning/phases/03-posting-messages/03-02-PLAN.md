---
phase: 03-posting-messages
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lens-editor/src/contexts/DisplayNameContext.tsx
  - lens-editor/src/components/DisplayNamePrompt/DisplayNamePrompt.tsx
  - lens-editor/src/components/DisplayNamePrompt/index.ts
  - lens-editor/src/components/DisplayNameBadge/DisplayNameBadge.tsx
  - lens-editor/src/components/DisplayNameBadge/index.ts
  - lens-editor/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "On first visit (no localStorage value), a non-closable overlay blocks all interaction until a display name is entered"
    - "After entering a name, it persists across browser sessions via localStorage"
    - "The display name appears at the top of the screen in the header bar"
    - "Clicking the displayed name opens an inline edit to change it"
    - "The overlay modal cannot be dismissed with Escape, click-outside, or any other mechanism except entering a name"
  artifacts:
    - path: "lens-editor/src/contexts/DisplayNameContext.tsx"
      provides: "DisplayNameProvider and useDisplayName hook"
      exports: ["DisplayNameProvider", "useDisplayName"]
    - path: "lens-editor/src/components/DisplayNamePrompt/DisplayNamePrompt.tsx"
      provides: "Non-closable overlay modal for display name entry"
      contains: "fixed inset-0"
    - path: "lens-editor/src/components/DisplayNameBadge/DisplayNameBadge.tsx"
      provides: "Clickable name display in header with inline editing"
      contains: "useDisplayName"
    - path: "lens-editor/src/App.tsx"
      provides: "DisplayNameProvider wrapping the entire app"
      contains: "DisplayNameProvider"
  key_links:
    - from: "lens-editor/src/App.tsx"
      to: "lens-editor/src/contexts/DisplayNameContext.tsx"
      via: "import and render DisplayNameProvider"
      pattern: "DisplayNameProvider"
    - from: "lens-editor/src/components/DisplayNamePrompt/DisplayNamePrompt.tsx"
      to: "lens-editor/src/contexts/DisplayNameContext.tsx"
      via: "useDisplayName hook"
      pattern: "useDisplayName"
    - from: "lens-editor/src/components/DisplayNameBadge/DisplayNameBadge.tsx"
      to: "lens-editor/src/contexts/DisplayNameContext.tsx"
      via: "useDisplayName hook"
      pattern: "useDisplayName"
---

<objective>
Create a global display name identity system using React context and localStorage, with a non-closable overlay modal for first-time setup and a clickable badge in the header.

Purpose: Establishes user identity (POST-02) that will be used for Discord message posting and future comments/suggestions features. The name persists across sessions and is globally accessible via React context.
Output: DisplayNameProvider context, DisplayNamePrompt overlay modal, DisplayNameBadge header component, App.tsx wired up.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-posting-messages/03-RESEARCH.md
@.planning/phases/03-posting-messages/03-CONTEXT.md
@lens-editor/src/App.tsx
@lens-editor/src/components/Layout/EditorArea.tsx
@lens-editor/src/components/DisconnectionModal/DisconnectionModal.tsx
@lens-editor/src/contexts/NavigationContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DisplayNameContext and DisplayNamePrompt</name>
  <files>
    lens-editor/src/contexts/DisplayNameContext.tsx
    lens-editor/src/components/DisplayNamePrompt/DisplayNamePrompt.tsx
    lens-editor/src/components/DisplayNamePrompt/index.ts
  </files>
  <action>
**DisplayNameContext.tsx** (`lens-editor/src/contexts/DisplayNameContext.tsx`):

Create a React context that stores the display name with localStorage persistence. Follow the pattern from NavigationContext.tsx (createContext + useXxx hook + throw on missing provider).

- `STORAGE_KEY = 'lens-editor-display-name'`
- Interface `DisplayNameContextValue { displayName: string | null; setDisplayName: (name: string) => void; }`
- `DisplayNameProvider` component:
  - `useState<string | null>` initialized from `localStorage.getItem(STORAGE_KEY)` wrapped in try/catch (returns null on error)
  - `setDisplayName` callback: trims the name, rejects empty strings (return early), sets state, writes to localStorage (try/catch for quota/private browsing)
  - Renders `<DisplayNameContext.Provider value={{ displayName, setDisplayName }}>{children}</DisplayNameContext.Provider>`
- `useDisplayName()` hook: reads context, throws if used outside provider (same pattern as `useNavigation`)
- Export both `DisplayNameProvider` and `useDisplayName`

**DisplayNamePrompt.tsx** (`lens-editor/src/components/DisplayNamePrompt/DisplayNamePrompt.tsx`):

Create a non-closable full-screen overlay modal. Use a PLAIN `<div>` overlay, NOT Radix Dialog (Radix dialogs are dismissable by design and we need to prevent all dismissal).

Follow the styling pattern from DisconnectionModal.tsx (`fixed inset-0 z-50 flex items-center justify-center bg-black/60`).

- Uses `useDisplayName()` to read `displayName` and `setDisplayName`
- If `displayName` is not null, return null (don't render)
- Local state: `input` (string), `inputRef` (for auto-focus)
- Auto-focus the input on mount via useEffect when displayName is null
- Outer div: `fixed inset-0 z-50 flex items-center justify-center bg-black/60`
  - `onKeyDown`: prevent Escape (`e.key === 'Escape'` -> `e.preventDefault()` + `e.stopPropagation()`)
  - `onKeyDown`: submit on Enter when `canSubmit` is true
- Inner card: `bg-white rounded-lg shadow-xl p-6 w-[400px] mx-4`
  - Heading: `"What should we call you?"` (text-lg font-semibold text-gray-900)
  - Subtext: `"This name will be shown on your messages and comments."` (text-sm text-gray-600)
  - Text input: `maxLength={66}` (80 minus 14 chars for " (unverified)" suffix -- see research Pitfall 4)
    - Placeholder: `"Enter your display name"`
    - Standard Tailwind input styling matching existing codebase
  - Continue button: full-width, disabled when input is empty/whitespace
    - `bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed`
  - Client-side validation: if input contains "clyde" (case-insensitive), show inline error text below the input: `"Name cannot contain 'clyde' (Discord restriction)"`. Do NOT call setDisplayName in this case.

**index.ts** (`lens-editor/src/components/DisplayNamePrompt/index.ts`):
```typescript
export { DisplayNamePrompt } from './DisplayNamePrompt';
```
  </action>
  <verify>
Run `cd /home/penguin/code/lens-relay/ws1/lens-editor && npx tsc --noEmit` to verify TypeScript compiles without errors.
  </verify>
  <done>
DisplayNameContext.tsx exports DisplayNameProvider and useDisplayName. DisplayNamePrompt renders a non-closable overlay when no display name is stored. Input is limited to 66 chars and rejects "clyde". TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DisplayNameBadge and wire into App</name>
  <files>
    lens-editor/src/components/DisplayNameBadge/DisplayNameBadge.tsx
    lens-editor/src/components/DisplayNameBadge/index.ts
    lens-editor/src/App.tsx
  </files>
  <action>
**DisplayNameBadge.tsx** (`lens-editor/src/components/DisplayNameBadge/DisplayNameBadge.tsx`):

A small clickable badge that shows the current display name. When clicked, it becomes an inline text input for editing. This component will be placed in the header bar.

- Uses `useDisplayName()` for `displayName` and `setDisplayName`
- If `displayName` is null, return null (prompt overlay handles the null state)
- Two modes: display mode and edit mode (local `editing` state boolean)
- **Display mode:**
  - Renders a `<button>` showing the display name text
  - Styling: `text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-2 py-1 rounded transition-colors cursor-pointer`
  - Add a small pencil/edit icon (inline SVG, 14x14) next to the name, visible on hover (`opacity-0 group-hover:opacity-100`)
  - On click: switch to edit mode, populate edit input with current display name
- **Edit mode:**
  - Renders a text input pre-filled with the current display name
  - Same `maxLength={66}` as the prompt
  - On Enter or blur: if input is non-empty and doesn't contain "clyde" (case-insensitive), call `setDisplayName(input)` and exit edit mode. If empty, revert to current name without saving.
  - On Escape: revert to display mode without saving
  - Auto-focus the input when entering edit mode
- Keep it compact -- this sits in the header alongside other controls

**index.ts** (`lens-editor/src/components/DisplayNameBadge/index.ts`):
```typescript
export { DisplayNameBadge } from './DisplayNameBadge';
```

**App.tsx modifications:**

1. Import `DisplayNameProvider` from `'./contexts/DisplayNameContext'`
2. Import `DisplayNamePrompt` from `'./components/DisplayNamePrompt'`
3. Wrap the entire app content in `<DisplayNameProvider>`:
   - The provider goes OUTSIDE the `NavigationContext.Provider` (it's app-global, not navigation-scoped)
   - Place `<DisplayNamePrompt />` inside the provider, before the main layout div

The resulting structure in App.tsx should be:
```tsx
return (
  <DisplayNameProvider>
    <DisplayNamePrompt />
    <NavigationContext.Provider value={...}>
      <div className="h-screen flex bg-gray-50">
        ...existing layout...
      </div>
    </NavigationContext.Provider>
  </DisplayNameProvider>
);
```

4. Also import `DisplayNameBadge` from `'./components/DisplayNameBadge'` BUT do NOT place it in App.tsx. It belongs in `EditorArea.tsx` header. However, EditorArea.tsx is NOT in this plan's files_modified (it will be modified in Plan 03). For now, just ensure the component exists and exports correctly. Plan 03 will add the DisplayNameBadge to the header.

Wait -- actually, the user decision says "display it at the top of the screen (global, not just in the panel)". The header bar is in EditorArea.tsx, which is inside RelayProvider. The DisplayNameBadge doesn't need relay context, so it can go in the header. But to avoid cross-plan file conflicts, we'll add the badge to the header in this task since we're already touching App.tsx. Actually EditorArea.tsx is a better location and will be touched by Plan 03.

**Revised approach:** In App.tsx, add a thin global header bar ABOVE the main layout that shows the DisplayNameBadge. This keeps it truly global (visible even without a document loaded) and outside the RelayProvider boundary:

```tsx
return (
  <DisplayNameProvider>
    <DisplayNamePrompt />
    <NavigationContext.Provider value={...}>
      <div className="h-screen flex flex-col bg-gray-50">
        {/* Global identity bar */}
        <div className="flex items-center justify-end px-4 py-1 bg-white border-b border-gray-100">
          <DisplayNameBadge />
        </div>
        <div className="flex-1 flex min-h-0">
          <Sidebar activeDocId={activeDocId} onSelectDocument={setActiveDocId} />
          <RelayProvider key={activeDocId} docId={activeDocId}>
            <AwarenessInitializer />
            <EditorArea currentDocId={activeDocId} />
            <DisconnectionModal />
          </RelayProvider>
        </div>
      </div>
    </NavigationContext.Provider>
  </DisplayNameProvider>
);
```

Note: The outer div changes from `h-screen flex` to `h-screen flex flex-col` to stack the identity bar above the main layout. The existing `flex` (horizontal) layout for sidebar + editor moves into a nested `flex-1 flex min-h-0` div.
  </action>
  <verify>
1. Run `cd /home/penguin/code/lens-relay/ws1/lens-editor && npx tsc --noEmit` -- TypeScript compiles cleanly.
2. Start the dev server: `cd /home/penguin/code/lens-relay/ws1/lens-editor && npm run dev &`
3. Open `http://dev.vps:5173` in browser:
   - On first visit (clear localStorage key `lens-editor-display-name` if exists): the overlay modal should appear, blocking all interaction
   - Enter a name and click Continue: modal disappears, name appears in top-right corner
   - Refresh the page: no modal (name persisted), name visible in header
   - Click the name: inline edit appears, can change name
4. Stop the dev server after testing.
  </verify>
  <done>
DisplayNameBadge renders in a global identity bar above the main layout. DisplayNameProvider wraps the entire app. DisplayNamePrompt shows on first visit, blocks interaction until name is entered. Name persists in localStorage across sessions. Clicking the badge allows inline editing.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd lens-editor && npx tsc --noEmit`
- First visit shows non-closable modal
- Entering a name dismisses modal, shows name in header
- Page refresh preserves the name (no modal)
- Clicking name allows editing
- Escape key does NOT dismiss the modal
- Name maxLength is 66 characters (accounts for " (unverified)" suffix)
- Names containing "clyde" are rejected client-side
</verification>

<success_criteria>
- DisplayNameProvider wraps the app and provides displayName + setDisplayName via context
- localStorage persists the name across sessions (POST-02)
- Non-closable overlay blocks all interaction when no name is set
- DisplayNameBadge in header shows current name, clickable to edit
- maxLength 66 enforced, "clyde" rejected client-side
</success_criteria>

<output>
After completion, create `.planning/phases/03-posting-messages/03-02-SUMMARY.md`
</output>
