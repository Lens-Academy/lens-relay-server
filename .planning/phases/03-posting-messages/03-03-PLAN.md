---
phase: 03-posting-messages
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - lens-editor/package.json
  - lens-editor/src/components/DiscussionPanel/ComposeBox.tsx
  - lens-editor/src/components/DiscussionPanel/useMessages.ts
  - lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx
autonomous: false

must_haves:
  truths:
    - "User types a message and presses Enter; the message appears in Discord and echoes back to the panel via SSE"
    - "Send button is disabled and Enter is ignored when input is whitespace-only"
    - "On send failure, message text restores into the input with inline error below"
    - "Input clears immediately on send and briefly disables to prevent double-send"
    - "Shift+Enter inserts a newline instead of sending"
    - "Placeholder shows 'Message #channel-name' matching the Discord-style pattern"
  artifacts:
    - path: "lens-editor/src/components/DiscussionPanel/ComposeBox.tsx"
      provides: "Auto-growing textarea with send button, error handling, double-send prevention"
      contains: "TextareaAutosize"
    - path: "lens-editor/src/components/DiscussionPanel/useMessages.ts"
      provides: "sendMessage function added to hook return value"
      exports: ["sendMessage in UseMessagesResult"]
    - path: "lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx"
      provides: "ComposeBox integrated below MessageList"
      contains: "ComposeBox"
  key_links:
    - from: "lens-editor/src/components/DiscussionPanel/ComposeBox.tsx"
      to: "lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx"
      via: "imported and rendered below MessageList"
      pattern: "<ComposeBox"
    - from: "lens-editor/src/components/DiscussionPanel/ComposeBox.tsx"
      to: "lens-editor/src/contexts/DisplayNameContext.tsx"
      via: "useDisplayName hook for username"
      pattern: "useDisplayName"
    - from: "lens-editor/src/components/DiscussionPanel/useMessages.ts"
      to: "/api/discord/channels/:channelId/messages"
      via: "fetch POST in sendMessage"
      pattern: "fetch.*method.*POST"
    - from: "lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx"
      to: "lens-editor/src/components/DiscussionPanel/useMessages.ts"
      via: "sendMessage destructured from useMessages"
      pattern: "sendMessage.*useMessages"
---

<objective>
Add the compose input to the DiscussionPanel that lets users type and send messages through the webhook proxy endpoint, with the display name from context.

Purpose: Completes the posting flow (POST-01). User types a message, presses Enter or clicks Send, it goes through the bridge webhook proxy (Plan 01) with the display name (Plan 02), and echoes back via SSE.
Output: Working compose box with auto-growing textarea, send functionality, error handling, and double-send prevention.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-posting-messages/03-RESEARCH.md
@.planning/phases/03-posting-messages/03-CONTEXT.md
@.planning/phases/03-posting-messages/03-01-SUMMARY.md
@.planning/phases/03-posting-messages/03-02-SUMMARY.md
@lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx
@lens-editor/src/components/DiscussionPanel/useMessages.ts
@lens-editor/src/components/DiscussionPanel/MessageList.tsx
@lens-editor/src/contexts/DisplayNameContext.tsx
@lens-editor/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-textarea-autosize, add sendMessage to useMessages, create ComposeBox</name>
  <files>
    lens-editor/package.json
    lens-editor/src/components/DiscussionPanel/useMessages.ts
    lens-editor/src/components/DiscussionPanel/ComposeBox.tsx
  </files>
  <action>
**Install dependency:**
```bash
cd /home/penguin/code/lens-relay/ws1/lens-editor && npm install react-textarea-autosize
```

**useMessages.ts modifications:**

1. Add `sendMessage` to the `UseMessagesResult` interface:
```typescript
sendMessage: (content: string, username: string) => Promise<void>;
```

2. Implement `sendMessage` as a `useCallback` inside the hook. It POSTs to the Vite-proxied bridge endpoint:
```typescript
const sendMessage = useCallback(
  async (content: string, username: string) => {
    if (!channelId) throw new Error('No channel ID');

    const res = await fetch(`/api/discord/channels/${channelId}/messages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, username }),
    });

    if (!res.ok) {
      const body = await res.json().catch(() => ({ error: 'Send failed' }));
      throw new Error(body.error || `HTTP ${res.status}`);
    }
    // No optimistic insert â€” message echoes back via SSE
  },
  [channelId]
);
```

3. Add `sendMessage` to the return object.

The Vite proxy (`/api/discord` -> `http://localhost:8091/api`) is already configured and handles rewriting. The POST goes to `/api/discord/channels/:channelId/messages` which the proxy rewrites to `/api/channels/:channelId/messages` on the bridge.

**ComposeBox.tsx** (`lens-editor/src/components/DiscussionPanel/ComposeBox.tsx`):

Create the compose input component. Import `TextareaAutosize` from `react-textarea-autosize` and `useDisplayName` from the context.

Props interface:
```typescript
interface ComposeBoxProps {
  channelName: string | null;
  onSend: (content: string, username: string) => Promise<void>;
  disabled?: boolean;
}
```

State:
- `value` (string) - current input text
- `sending` (boolean) - true while POST is in flight
- `error` (string | null) - inline error message

`canSend = value.trim().length > 0 && !sending && !disabled`

`handleSend` (async):
1. Guard: if `!canSend` return
2. Save `content = value.trim()`
3. `setValue('')` -- clear immediately
4. `setSending(true)` -- disable input to prevent double-send
5. `setError(null)` -- clear any previous error
6. Get `displayName` from `useDisplayName()` hook. If null, set error "Set a display name first" and restore value. (This shouldn't happen because the modal blocks, but be defensive.)
7. Try: `await onSend(content, displayName)`
8. Catch: `setValue(content)` to restore, `setError('Failed to send -- try again')`
9. Finally: `setSending(false)`

`handleKeyDown`:
- `Enter` without Shift: `e.preventDefault()` + `handleSend()`
- `Shift+Enter`: do nothing (default textarea behavior inserts newline)

Render:
```tsx
<div className="border-t border-gray-200 px-3 py-2">
  {error && <p className="text-xs text-red-600 mb-1">{error}</p>}
  <div className="flex items-end gap-2">
    <TextareaAutosize
      value={value}
      onChange={(e) => { setValue(e.target.value); setError(null); }}
      onKeyDown={handleKeyDown}
      placeholder={channelName ? `Message #${channelName}` : 'Send a message'}
      maxRows={4}
      minRows={1}
      disabled={sending || disabled}
      className="flex-1 resize-none px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
    />
    <button
      onClick={handleSend}
      disabled={!canSend}
      className="p-2 text-blue-600 hover:text-blue-700 disabled:text-gray-300 disabled:cursor-not-allowed transition-colors flex-shrink-0"
      aria-label="Send message"
    >
      {/* Send arrow SVG icon, 20x20 */}
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path d="M2.94 17.94a1 1 0 01-.34-1.47l4.13-6.47-4.13-6.47a1 1 0 011.34-1.47l14 7a1 1 0 010 1.88l-14 7a1 1 0 01-1-.06z" />
      </svg>
    </button>
  </div>
</div>
```

Important: `useDisplayName()` is called at the TOP of ComposeBox (hook rules), not inside handleSend. The `displayName` value is read from the hook and used in handleSend via closure.

Actually, re-reading the props interface -- the `onSend` callback takes `(content, username)`. The ComposeBox itself should read the display name from context and pass it. This keeps the DiscussionPanel simpler (it just passes `sendMessage` from useMessages as `onSend`).

Revised approach: ComposeBox uses `useDisplayName()` internally and calls `onSend(content, displayName!)` in handleSend. The guard for null displayName is the defensive check mentioned above.
  </action>
  <verify>
Run `cd /home/penguin/code/lens-relay/ws1/lens-editor && npx tsc --noEmit` -- TypeScript compiles cleanly.
  </verify>
  <done>
react-textarea-autosize installed. useMessages returns sendMessage function. ComposeBox component created with auto-growing textarea, Enter-to-send, Shift+Enter for newlines, double-send prevention, and error recovery.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ComposeBox into DiscussionPanel</name>
  <files>lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx</files>
  <action>
Modify DiscussionPanel.tsx to include the ComposeBox below the MessageList.

1. Import `ComposeBox` from `'./ComposeBox'`
2. Destructure `sendMessage` from `useMessages(channelId)` (added in Task 1)
3. Add `<ComposeBox>` below the `<MessageList>` in the non-loading, non-error branch

The key layout change: the content area currently renders either loading, error, or MessageList. The ComposeBox should always be visible at the bottom when the panel is showing (not during loading or error states). The panel uses `flex flex-col` so ComposeBox docks at the bottom naturally.

Updated JSX structure:
```tsx
<aside className="w-80 flex-shrink-0 border-l border-gray-200 bg-white flex flex-col" ...>
  {/* Header -- unchanged */}
  <div className="px-3 py-2 border-b border-gray-200 ...">...</div>

  {/* Content area */}
  {loading && messages.length === 0 ? (
    <div className="flex-1 flex items-center justify-center p-4">
      <p className="text-sm text-gray-400">Loading messages...</p>
    </div>
  ) : error ? (
    <div className="flex-1 flex flex-col items-center justify-center p-4 gap-3">
      <p className="text-sm text-red-600">{error}</p>
      <button onClick={refetch} ...>Retry</button>
    </div>
  ) : (
    <>
      <MessageList messages={messages} />
      <ComposeBox channelName={channelName} onSend={sendMessage} />
    </>
  )}
</aside>
```

The `<>...</>` fragment wraps MessageList + ComposeBox. MessageList already uses `flex-1` to take remaining space, and ComposeBox has `border-t` to visually separate it.

Note: `sendMessage` from useMessages has signature `(content: string, username: string) => Promise<void>` which matches what ComposeBox's `onSend` prop expects.
  </action>
  <verify>
Run `cd /home/penguin/code/lens-relay/ws1/lens-editor && npx tsc --noEmit` -- TypeScript compiles cleanly.
  </verify>
  <done>
ComposeBox renders below MessageList in the DiscussionPanel. The compose input is visible when messages are loaded, hidden during loading/error states.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full posting flow end-to-end</name>
  <what-built>
Complete message posting flow: display name modal on first visit, compose box in discussion panel, messages sent through bridge webhook proxy to Discord, echoing back via SSE.
  </what-built>
  <how-to-verify>
Prerequisites: You need a Discord webhook URL for a test channel.
1. Create a webhook in your Discord test channel (Server Settings -> Integrations -> Webhooks -> New Webhook -> Copy URL)
2. Set the environment variable for the bridge: `DISCORD_WEBHOOK_URL=<your-webhook-url>`
3. Start the bridge: `cd /home/penguin/code/lens-relay/ws1/discord-bridge && DISCORD_WEBHOOK_URL=<url> npm run dev`
4. Start the editor: `cd /home/penguin/code/lens-relay/ws1/lens-editor && npm run dev:local`
5. Open `http://dev.vps:5173` in browser

Test the flow:
- **Identity modal:** On first visit (or after clearing localStorage `lens-editor-display-name`), the modal should appear. Try pressing Escape -- it should NOT dismiss. Enter a name and click Continue.
- **Name in header:** Your name should appear in the top-right of the screen. Click it to edit.
- **Compose box:** Open a document with a `discussion` frontmatter field. The compose box should appear at the bottom of the discussion panel.
- **Send a message:** Type "Hello from lens-editor!" and press Enter. The input should clear immediately. Within 1-3 seconds, the message should appear in the panel (echoed via SSE) AND in the Discord channel.
- **Discord appearance:** In Discord, the message should show as posted by "YourName (unverified)" with the default webhook avatar.
- **Send failure:** Stop the bridge, try sending -- the input should restore with an error message.
- **Shift+Enter:** Should insert a newline, not send.
- **Empty send:** Whitespace-only input should not be sendable (button disabled, Enter does nothing).

Expected behavior:
- Messages arrive in Discord within 1-3 seconds of pressing Enter
- The author name in Discord shows "(unverified)" suffix
- The webhook URL is NOT visible in browser DevTools Network tab (only `/api/discord/channels/...` requests)
  </how-to-verify>
  <resume-signal>Type "approved" to confirm posting works end-to-end, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd lens-editor && npx tsc --noEmit`
- react-textarea-autosize is in package.json dependencies
- ComposeBox renders below MessageList in discussion panel
- Enter sends message, Shift+Enter inserts newline
- Input clears on send, restores on failure
- sendMessage in useMessages POSTs to `/api/discord/channels/:channelId/messages`
- DisplayName from context is passed as username in the POST body
- End-to-end: message appears in Discord with "(unverified)" suffix
</verification>

<success_criteria>
- User can type a message and press Enter to send it to Discord (POST-01)
- Messages show "DisplayName (unverified)" in Discord (POST-03)
- Input clears immediately, briefly disables to prevent double-send
- Failed sends restore the message text with inline error
- Compose box placeholder shows "Message #channel-name"
- Auto-growing textarea works up to 4 lines
</success_criteria>

<output>
After completion, create `.planning/phases/03-posting-messages/03-03-SUMMARY.md`
</output>
