---
phase: 01-bridge-history-display
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx
  - lens-editor/src/components/DiscussionPanel/MessageList.tsx
  - lens-editor/src/components/DiscussionPanel/MessageItem.tsx
  - lens-editor/src/components/DiscussionPanel/useDiscussion.ts
  - lens-editor/src/components/DiscussionPanel/useMessages.ts
  - lens-editor/src/components/DiscussionPanel/index.ts
  - lens-editor/src/components/Layout/EditorArea.tsx
autonomous: false

must_haves:
  truths:
    - "User opens a document with `discussion` frontmatter and sees a chat panel to the right of the existing sidebar"
    - "Panel shows loading spinner while fetching messages"
    - "Panel displays the last 50 messages with author username, avatar image, and timestamp"
    - "Channel name appears as the panel header"
    - "Documents without a `discussion` field show no chat panel (no extra sidebar)"
    - "Consecutive messages from the same author within 5 minutes are visually grouped"
  artifacts:
    - path: "lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx"
      provides: "Main panel component that conditionally renders based on discussion frontmatter"
      min_lines: 40
    - path: "lens-editor/src/components/DiscussionPanel/MessageList.tsx"
      provides: "Scrollable message list component"
      min_lines: 20
    - path: "lens-editor/src/components/DiscussionPanel/MessageItem.tsx"
      provides: "Single message with avatar, username, timestamp"
      min_lines: 30
    - path: "lens-editor/src/components/DiscussionPanel/useDiscussion.ts"
      provides: "Hook: extracts discussion channel ID from Y.Doc text"
      exports: ["useDiscussion"]
    - path: "lens-editor/src/components/DiscussionPanel/useMessages.ts"
      provides: "Hook: fetches messages from proxy API"
      exports: ["useMessages"]
    - path: "lens-editor/src/components/Layout/EditorArea.tsx"
      provides: "Integration point for DiscussionPanel"
      contains: "DiscussionPanel"
  key_links:
    - from: "lens-editor/src/components/DiscussionPanel/useDiscussion.ts"
      to: "lens-editor/src/lib/frontmatter.ts"
      via: "import extractFrontmatter"
      pattern: "extractFrontmatter"
    - from: "lens-editor/src/components/DiscussionPanel/useDiscussion.ts"
      to: "lens-editor/src/lib/discord-url.ts"
      via: "import parseDiscordUrl"
      pattern: "parseDiscordUrl"
    - from: "lens-editor/src/components/DiscussionPanel/useMessages.ts"
      to: "/api/discord/channels/:channelId/messages"
      via: "fetch call to Vite proxy"
      pattern: "fetch.*api/discord"
    - from: "lens-editor/src/components/DiscussionPanel/MessageItem.tsx"
      to: "lens-editor/src/lib/discord-avatar.ts"
      via: "import getAvatarUrl"
      pattern: "getAvatarUrl"
    - from: "lens-editor/src/components/DiscussionPanel/MessageItem.tsx"
      to: "lens-editor/src/lib/format-timestamp.ts"
      via: "import formatTimestamp"
      pattern: "formatTimestamp"
    - from: "lens-editor/src/components/Layout/EditorArea.tsx"
      to: "lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx"
      via: "import and render DiscussionPanel"
      pattern: "DiscussionPanel"
---

<objective>
Build the DiscussionPanel React component and integrate it into EditorArea, creating the visible chat sidebar that appears when a document has a `discussion` frontmatter field.

Purpose: This is the user-facing deliverable of Phase 1 -- the chat panel that shows Discord message history alongside the document editor.

Output: A working DiscussionPanel with message list, avatars, timestamps, loading/error/empty states, and conditional rendering in EditorArea.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bridge-history-display/01-CONTEXT.md
@.planning/phases/01-bridge-history-display/01-RESEARCH.md
@.planning/phases/01-bridge-history-display/01-01-SUMMARY.md
@.planning/phases/01-bridge-history-display/01-02-SUMMARY.md
@lens-editor/src/components/Layout/EditorArea.tsx
@lens-editor/src/components/BacklinksPanel/BacklinksPanel.tsx
@lens-editor/src/components/CommentsPanel/CommentsPanel.tsx
@lens-editor/src/components/Editor/Editor.tsx
@lens-editor/src/lib/frontmatter.ts
@lens-editor/src/lib/discord-url.ts
@lens-editor/src/lib/discord-avatar.ts
@lens-editor/src/lib/format-timestamp.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDiscussion and useMessages hooks</name>
  <files>
    lens-editor/src/components/DiscussionPanel/useDiscussion.ts
    lens-editor/src/components/DiscussionPanel/useMessages.ts
  </files>
  <action>
    1. Create `useDiscussion.ts`:
       - Import `useState`, `useEffect` from React
       - Import `useYDoc` from `@y-sweet/react`
       - Import `extractFrontmatter` from `../../lib/frontmatter`
       - Import `parseDiscordUrl` from `../../lib/discord-url`
       - Export `useDiscussion()` hook that returns `{ channelId: string | null, guildId: string | null }`
       - Implementation:
         - Get ydoc via `useYDoc()`
         - Get Y.Text via `ydoc.getText('contents')`
         - On mount and on Y.Text observe, extract frontmatter and parse discord URL
         - Use a debounce: only re-parse if the first 500 characters change (frontmatter is at the top). Simple approach: store previous text prefix, only re-extract if it changed.
         - Clean up observer on unmount
         - Return `{ channelId, guildId }` -- both null if no discussion field or invalid URL

    2. Create `useMessages.ts`:
       - Import `useState`, `useEffect` from React
       - Import types: define `DiscordMessage` and `DiscordChannel` interfaces inline (matching the types from discord-bridge/src/types.ts: id, content, author with id/username/global_name/avatar, timestamp, type)
       - Export `useMessages(channelId: string | null)` hook that returns `{ messages: DiscordMessage[], channelName: string | null, loading: boolean, error: string | null }`
       - Implementation:
         - When `channelId` changes (and is not null):
           - Set `loading: true`, `error: null`
           - Fetch messages: `fetch(\`/api/discord/channels/${channelId}/messages?limit=50\`)`
           - Fetch channel info: `fetch(\`/api/discord/channels/${channelId}\`)` (in parallel)
           - On success: set messages (reverse array -- Discord returns newest first, we want oldest first), set channelName from channel info, set `loading: false`
           - On error: set `error` to descriptive message, set `loading: false`
           - Handle 429: set error to "Rate limited, try again in X seconds"
           - Handle network errors: set error to "Could not connect to Discord bridge"
         - When `channelId` is null: reset all state (empty messages, no loading, no error)
         - Use AbortController for fetch cleanup on unmount or channelId change (prevent stale responses)
       - Export the `DiscordMessage` and `DiscordChannel` types for use by other components
  </action>
  <verify>
    ```bash
    # TypeScript compiles
    cd lens-editor && npx tsc --noEmit 2>&1 | head -20
    ```
  </verify>
  <done>Two hooks exist: useDiscussion extracts channel ID from Y.Doc, useMessages fetches messages from the proxy API. Both handle error and loading states.</done>
</task>

<task type="auto">
  <name>Task 2: Create DiscussionPanel components and integrate into EditorArea</name>
  <files>
    lens-editor/src/components/DiscussionPanel/MessageItem.tsx
    lens-editor/src/components/DiscussionPanel/MessageList.tsx
    lens-editor/src/components/DiscussionPanel/DiscussionPanel.tsx
    lens-editor/src/components/DiscussionPanel/index.ts
    lens-editor/src/components/Layout/EditorArea.tsx
  </files>
  <action>
    1. Create `MessageItem.tsx`:
       - Import `getAvatarUrl` from `../../lib/discord-avatar`
       - Import `formatTimestamp` from `../../lib/format-timestamp`
       - Import `DiscordMessage` type from `./useMessages`
       - Props: `{ message: DiscordMessage, showHeader: boolean }` -- showHeader controls whether to show avatar/name/timestamp (false for grouped messages from same author)
       - Render:
         - When `showHeader` is true: avatar image (32px, rounded-full), display name (use `author.global_name || author.username`), timestamp
         - When `showHeader` is false: just the message content with left padding to align with text above
         - Message content: plain text in `<p>` tag, `whitespace-pre-wrap` to preserve line breaks
         - Avatar: `<img>` with `src={getAvatarUrl(author.id, author.avatar, 64)}`, `alt={displayName}`, `loading="lazy"`. Add `onError` handler that sets src to default avatar (in case CDN URL fails).
         - Timestamp: `formatTimestamp(message.timestamp)` -- the format-timestamp utility accepts ISO strings
       - Use Tailwind classes matching the existing design system (gray-900 for names, gray-500 for timestamps, text-sm for content)

    2. Create `MessageList.tsx`:
       - Import `MessageItem` and `DiscordMessage` type
       - Props: `{ messages: DiscordMessage[] }`
       - Group consecutive messages: messages from the same author within 5 minutes of each other are grouped (only first shows header). Compute `showHeader` for each message by comparing with previous message's author.id and timestamp.
       - Render scrollable list with `overflow-y-auto` and `flex-1`
       - When messages array is empty (after loading completes): show "No messages yet" empty state
       - Add a `ref` to the scroll container and scroll to bottom on initial render using `useEffect` with `scrollTop = scrollHeight`

    3. Create `DiscussionPanel.tsx`:
       - Import `useDiscussion` and `useMessages` hooks
       - Import `MessageList`
       - The panel renders as a SEPARATE sidebar to the right of the existing sidebar (not inside the existing `<aside>`).
       - Call `useDiscussion()` to get channelId
       - Call `useMessages(channelId)` to get messages, channelName, loading, error
       - **If channelId is null: return null** (renders nothing, no extra sidebar)
       - If channelId exists, render the panel:
         - Container: `w-80 flex-shrink-0 border-l border-gray-200 bg-white flex flex-col` (320px wide panel)
         - Header: channel name as `#channel-name` with Discord-style `#` prefix. Use `text-xs font-semibold text-gray-500 uppercase tracking-wider` matching existing panel headers. If channelName is null (still loading), show placeholder.
         - Loading state: centered spinner (simple animated SVG or Tailwind `animate-spin` on a circle). Show while `loading` is true and messages array is empty.
         - Error state: centered error message with "Retry" button. The retry button calls a `refetch` function (add to useMessages return: a `refetch()` callback that re-triggers the fetch).
         - Messages state: `<MessageList messages={messages} />`

    4. Create `index.ts` barrel file:
       ```typescript
       export { DiscussionPanel } from './DiscussionPanel'
       ```

    5. Update `EditorArea.tsx`:
       - Import `DiscussionPanel` from `../DiscussionPanel`
       - Add DiscussionPanel AFTER the existing `<aside>` element (as a sibling, not inside it). This creates a second sidebar column that only appears when the panel has content to show.
       - The DiscussionPanel needs access to the Y.Doc context (it uses `useYDoc` internally via useDiscussion hook), which is already provided by the RelayProvider boundary that wraps EditorArea.
       - Result in JSX:
         ```tsx
         {/* Editor + Sidebars container */}
         <div className="flex-1 flex min-h-0">
           {/* Editor */}
           <div className="flex-1 px-4 py-6 min-w-0 overflow-auto">
             <Editor ... />
           </div>
           {/* Right Sidebars */}
           <aside className="w-64 flex-shrink-0 border-l border-gray-200 bg-white flex flex-col">
             {/* ToC, Backlinks, Comments -- existing */}
           </aside>
           {/* Discussion Panel (conditional on frontmatter) */}
           <DiscussionPanel />
         </div>
         ```
       - No props needed -- DiscussionPanel reads Y.Doc from context and returns null when there's no discussion field.
  </action>
  <verify>
    ```bash
    # TypeScript compiles
    cd lens-editor && npx tsc --noEmit

    # Existing tests still pass (EditorArea changes don't break anything)
    cd lens-editor && npx vitest run

    # Build succeeds
    cd lens-editor && npx vite build 2>&1 | tail -5
    ```
  </verify>
  <done>DiscussionPanel component renders conditionally in EditorArea. Shows loading, error, empty, and message states. Messages display with avatars, usernames, and timestamps. Panel only appears for documents with discussion frontmatter.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 deliverable: the Discord Discussion Panel.

    When a document has `discussion: https://discord.com/channels/GUILD/CHANNEL` in its frontmatter:
    - A chat panel appears to the right of the existing sidebar
    - Shows the channel name as header
    - Displays the last 50 messages with avatars, usernames, and timestamps
    - Consecutive messages from the same author are grouped
    - Loading spinner shown while fetching
    - Error state with retry button on failure
    - Documents without `discussion` field show no panel
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    - Discord bridge running: `cd discord-bridge && DISCORD_BOT_TOKEN=your-token npm run dev`
    - Local relay running: `cd lens-editor && npm run relay:start` then `npm run relay:setup`
    - Vite dev server: `cd lens-editor && npm run dev:local`

    **Test 1: Document with discussion field**
    1. Open the editor at http://dev.vps:5173 (or http://localhost:5173 on VPS)
    2. Edit a test document to add frontmatter: `discussion: https://discord.com/channels/YOUR_GUILD_ID/YOUR_CHANNEL_ID`
    3. Verify: A chat panel appears to the right showing messages from that Discord channel
    4. Verify: Each message shows an avatar image, username, and relative timestamp
    5. Verify: Messages are in chronological order (oldest at top, newest at bottom)
    6. Verify: The panel header shows the channel name with # prefix

    **Test 2: Document without discussion field**
    1. Open a document that has no `discussion` field in its frontmatter
    2. Verify: No chat panel appears -- the layout looks identical to before this feature

    **Test 3: Error handling**
    1. Stop the discord-bridge process
    2. Open a document with a discussion field
    3. Verify: Panel shows an error message with a "Retry" button
    4. Restart the discord-bridge
    5. Click "Retry"
    6. Verify: Messages load successfully
  </how-to-verify>
  <resume-signal>Type "approved" if the panel works correctly, or describe any visual or functional issues.</resume-signal>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles clean
cd lens-editor && npx tsc --noEmit

# All tests pass (including new utility tests from Plan 01)
cd lens-editor && npx vitest run

# Build succeeds
cd lens-editor && npx vite build 2>&1 | tail -5
```
</verification>

<success_criteria>
- DiscussionPanel component exists with loading, error, empty, and message states
- Panel appears ONLY when document has `discussion` frontmatter field
- Panel shows channel name as header
- Messages show author avatar (with fallback), username (global_name preferred), and formatted timestamp
- Consecutive same-author messages within 5 minutes are visually grouped
- Panel integrates cleanly with existing EditorArea layout (no regressions to existing sidebar)
- All existing tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-bridge-history-display/01-03-SUMMARY.md`
</output>
