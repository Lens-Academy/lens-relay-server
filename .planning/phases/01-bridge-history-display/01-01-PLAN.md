---
phase: 01-bridge-history-display
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lens-editor/src/lib/frontmatter.ts
  - lens-editor/src/lib/frontmatter.test.ts
  - lens-editor/src/lib/discord-url.ts
  - lens-editor/src/lib/discord-url.test.ts
  - lens-editor/src/lib/discord-avatar.ts
  - lens-editor/src/lib/discord-avatar.test.ts
  - lens-editor/src/lib/format-timestamp.ts
  - lens-editor/src/lib/format-timestamp.test.ts
autonomous: true

must_haves:
  truths:
    - "Frontmatter with a `discussion` field is correctly extracted from Y.Text markdown strings"
    - "Discord channel URLs are parsed into guild and channel IDs"
    - "Invalid or missing discussion fields return null, not errors"
    - "Avatar URLs are correctly constructed for users with custom avatars, animated avatars, and default avatars"
    - "Timestamps display relative for recent messages, absolute for older ones"
  artifacts:
    - path: "lens-editor/src/lib/frontmatter.ts"
      provides: "extractFrontmatter() function"
      exports: ["extractFrontmatter"]
    - path: "lens-editor/src/lib/discord-url.ts"
      provides: "parseDiscordUrl() function"
      exports: ["parseDiscordUrl"]
    - path: "lens-editor/src/lib/discord-avatar.ts"
      provides: "getAvatarUrl() function"
      exports: ["getAvatarUrl"]
    - path: "lens-editor/src/lib/format-timestamp.ts"
      provides: "formatTimestamp() function extracted from CommentsPanel"
      exports: ["formatTimestamp"]
  key_links:
    - from: "lens-editor/src/lib/frontmatter.ts"
      to: "front-matter npm package"
      via: "import fm from 'front-matter'"
      pattern: "import.*front-matter"
    - from: "lens-editor/src/lib/discord-url.ts"
      to: "lens-editor/src/lib/frontmatter.ts"
      via: "Caller passes discussion URL extracted by extractFrontmatter"
      pattern: "parseDiscordUrl"
---

<objective>
Create and test the four utility functions needed by the DiscussionPanel: frontmatter extraction, Discord URL parsing, avatar URL construction, and timestamp formatting.

Purpose: These pure functions form the data pipeline from Y.Doc text to displayable Discord message data. TDD ensures correct handling of edge cases (empty frontmatter, invalid URLs, missing avatars, time boundary formatting) before any UI depends on them.

Output: Four tested utility modules in `lens-editor/src/lib/` plus the `front-matter` npm dependency installed.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bridge-history-display/01-RESEARCH.md
@lens-editor/src/lib/link-extractor.ts
@lens-editor/src/lib/link-extractor.test.ts
@lens-editor/src/components/CommentsPanel/CommentsPanel.tsx
@lens-editor/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install front-matter dependency and create utility modules with tests (RED)</name>
  <files>
    lens-editor/package.json
    lens-editor/src/lib/frontmatter.ts
    lens-editor/src/lib/frontmatter.test.ts
    lens-editor/src/lib/discord-url.ts
    lens-editor/src/lib/discord-url.test.ts
    lens-editor/src/lib/discord-avatar.ts
    lens-editor/src/lib/discord-avatar.test.ts
    lens-editor/src/lib/format-timestamp.ts
    lens-editor/src/lib/format-timestamp.test.ts
  </files>
  <action>
    1. Install the `front-matter` npm package in `lens-editor/`:
       ```bash
       cd lens-editor && npm install front-matter
       ```

    2. Create test files FIRST (RED phase). Write tests for all four modules before writing any implementations.

    **frontmatter.test.ts** - Test `extractFrontmatter(text: string)`:
    - Valid frontmatter with `discussion` field returns `{ discussion: "https://discord.com/channels/123/456" }`
    - Valid frontmatter without `discussion` field returns object without `discussion` key
    - Text without frontmatter delimiters returns `null`
    - Empty string returns `null`
    - Frontmatter with other fields (title, id, slug) alongside discussion returns all fields
    - Malformed YAML (unclosed quotes, invalid syntax) returns `null` (not throw)
    - Text with only opening `---` delimiter returns `null`
    - Windows line endings (`\r\n`) in frontmatter are handled correctly

    **discord-url.test.ts** - Test `parseDiscordUrl(url: string)`:
    - `https://discord.com/channels/1234/5678` returns `{ guildId: "1234", channelId: "5678" }`
    - `https://discord.com/channels/1234/5678/` (trailing slash) returns `{ guildId: "1234", channelId: "5678" }`
    - `http://discord.com/channels/1234/5678` (http) returns valid result
    - `https://www.discord.com/channels/1234/5678` (www prefix) returns valid result
    - Empty string returns `null`
    - `https://discord.com/channels/1234` (missing channel) returns `null`
    - `https://discord.com/invite/abc` (not a channel URL) returns `null`
    - `not a url` returns `null`
    - Real-world snowflake IDs: `https://discord.com/channels/1440725236843806762/1465349126073094469` returns correct IDs

    **discord-avatar.test.ts** - Test `getAvatarUrl(userId: string, avatarHash: string | null, size?: number)`:
    - User with custom avatar: `getAvatarUrl("123", "abc123")` returns `https://cdn.discordapp.com/avatars/123/abc123.png?size=64`
    - Custom avatar with explicit size: `getAvatarUrl("123", "abc123", 128)` returns URL with `?size=128`
    - Animated avatar (starts with `a_`): `getAvatarUrl("123", "a_abc123")` returns URL ending `.gif?size=64`
    - Null avatar (default avatar): `getAvatarUrl("123456789012345678", null)` returns `https://cdn.discordapp.com/embed/avatars/{N}.png` where N = `(BigInt("123456789012345678") >> 22n) % 6n`
    - Default avatar index is a number 0-5

    **format-timestamp.test.ts** - Test `formatTimestamp(isoString: string)`:
    NOTE: The Discord API returns ISO8601 timestamps as strings (e.g., "2025-01-15T12:30:00.000Z"), not epoch milliseconds. This function accepts ISO strings and formats them.
    - Timestamp from less than 1 minute ago returns "just now"
    - Timestamp from 5 minutes ago returns "5m ago"
    - Timestamp from 3 hours ago returns "3h ago"
    - Timestamp from 2 days ago returns "2d ago"
    - Timestamp from 2 weeks ago returns date like "Jan 15"
    - Timestamp from over a year ago includes the year like "Jan 15, 2024"
    - Use `vi.useFakeTimers()` to make time-based tests deterministic

    3. Create stub implementations that export the correct function signatures but return hardcoded wrong values (to make tests fail).

    4. Run tests to confirm they ALL FAIL (RED):
       ```bash
       cd lens-editor && npx vitest run src/lib/frontmatter.test.ts src/lib/discord-url.test.ts src/lib/discord-avatar.test.ts src/lib/format-timestamp.test.ts
       ```
  </action>
  <verify>All test files exist. `npx vitest run src/lib/frontmatter.test.ts src/lib/discord-url.test.ts src/lib/discord-avatar.test.ts src/lib/format-timestamp.test.ts` runs and ALL tests FAIL (red phase).</verify>
  <done>Four test files with comprehensive test cases exist. Four stub source files export correct signatures. All tests fail.</done>
</task>

<task type="auto">
  <name>Task 2: Implement all four utility functions (GREEN + REFACTOR)</name>
  <files>
    lens-editor/src/lib/frontmatter.ts
    lens-editor/src/lib/discord-url.ts
    lens-editor/src/lib/discord-avatar.ts
    lens-editor/src/lib/format-timestamp.ts
    lens-editor/src/components/CommentsPanel/CommentsPanel.tsx
  </files>
  <action>
    Implement each function to make all tests pass:

    **frontmatter.ts:**
    ```typescript
    import fm from 'front-matter'

    interface DocFrontmatter {
      discussion?: string
      [key: string]: unknown
    }

    export function extractFrontmatter(text: string): DocFrontmatter | null {
      if (!fm.test(text)) return null
      try {
        const { attributes } = fm<DocFrontmatter>(text)
        return attributes
      } catch {
        return null
      }
    }
    ```

    **discord-url.ts:**
    Use regex `^https?:\/\/(?:www\.)?discord\.com\/channels\/(\d+)\/(\d+)\/?$` to extract guildId and channelId. Return `null` for non-matching strings.

    **discord-avatar.ts:**
    - If `avatarHash` is non-null: return `https://cdn.discordapp.com/avatars/${userId}/${avatarHash}.${ext}?size=${size}` where ext is `gif` if hash starts with `a_`, else `png`. Default size 64.
    - If `avatarHash` is null: compute default index as `Number((BigInt(userId) >> 22n) % 6n)`, return `https://cdn.discordapp.com/embed/avatars/${index}.png`.

    **format-timestamp.ts:**
    Accept ISO8601 string. Parse with `new Date(isoString)`. Compute diff from `Date.now()`. Use same thresholds as CommentsPanel's `formatTimestamp` but accept ISO string input instead of epoch millis. After implementation works, refactor CommentsPanel to import from this shared module instead of having its own copy (DRY).

    Update `CommentsPanel.tsx`: Remove the local `formatTimestamp` function definition. Import from `../../lib/format-timestamp`. The CommentsPanel currently calls `formatTimestamp(timestamp)` where `timestamp` is epoch millis from comment metadata. The shared function accepts ISO strings from Discord. To keep CommentsPanel working, either:
    - Add an overload/variant that accepts millis (detect by type: string = ISO, number = millis), OR
    - Keep the CommentsPanel function signature accepting number and have the shared version accept both types.

    The cleanest approach: make `formatTimestamp` accept `string | number`. If number, use directly as epoch millis. If string, parse with `new Date()`.

    Run all tests:
    ```bash
    cd lens-editor && npx vitest run src/lib/frontmatter.test.ts src/lib/discord-url.test.ts src/lib/discord-avatar.test.ts src/lib/format-timestamp.test.ts
    ```

    Then run the existing CommentsPanel tests to ensure no regression:
    ```bash
    cd lens-editor && npx vitest run src/components/CommentsPanel/
    ```
  </action>
  <verify>`npx vitest run src/lib/frontmatter.test.ts src/lib/discord-url.test.ts src/lib/discord-avatar.test.ts src/lib/format-timestamp.test.ts` -- ALL tests PASS. `npx vitest run src/components/CommentsPanel/` -- existing tests still pass (no regression from extracting formatTimestamp).</verify>
  <done>All four utility functions implemented and passing tests. CommentsPanel refactored to use shared formatTimestamp. No regressions.</done>
</task>

</tasks>

<verification>
```bash
# All new utility tests pass
cd lens-editor && npx vitest run src/lib/frontmatter.test.ts src/lib/discord-url.test.ts src/lib/discord-avatar.test.ts src/lib/format-timestamp.test.ts

# CommentsPanel tests pass (no regression from extracting formatTimestamp)
cd lens-editor && npx vitest run src/components/CommentsPanel/

# Full test suite passes
cd lens-editor && npx vitest run
```
</verification>

<success_criteria>
- `front-matter` package is in lens-editor/package.json dependencies
- All four utility functions exist with correct exports
- All test cases pass (covering happy path, edge cases, error cases)
- CommentsPanel uses shared formatTimestamp (no duplication)
- Full test suite has no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/01-bridge-history-display/01-01-SUMMARY.md`
</output>
