---
phase: 01-bridge-history-display
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - discord-bridge/package.json
  - discord-bridge/tsconfig.json
  - discord-bridge/src/index.ts
  - discord-bridge/src/discord-client.ts
  - discord-bridge/src/types.ts
  - lens-editor/vite.config.ts
autonomous: false
user_setup:
  - service: discord
    why: "Bot token needed to read messages from Discord channels"
    env_vars:
      - name: DISCORD_BOT_TOKEN
        source: "Discord Developer Portal (https://discord.com/developers/applications) -> Your App -> Bot -> Token"
    dashboard_config:
      - task: "Create a Discord bot application (if not already done)"
        location: "Discord Developer Portal -> New Application"
      - task: "Enable MESSAGE_CONTENT privileged intent"
        location: "Discord Developer Portal -> Your App -> Bot -> Privileged Gateway Intents -> MESSAGE CONTENT"
      - task: "Invite bot to the guild containing target channels"
        location: "Discord Developer Portal -> Your App -> OAuth2 -> URL Generator -> Scopes: bot -> Permissions: Read Messages/View Channels, Read Message History"

must_haves:
  truths:
    - "Sidecar proxy starts and listens on configured port"
    - "GET /api/channels/:channelId/messages returns Discord messages with author, content, and timestamp"
    - "Bot token is never exposed to the browser"
    - "Vite dev server proxies /api/discord/* requests to the sidecar"
    - "Rate-limited responses (429) are handled gracefully with retry info"
    - "Responses are cached briefly to avoid hitting Discord rate limits on rapid document switches"
  artifacts:
    - path: "discord-bridge/package.json"
      provides: "Sidecar project definition"
      contains: "hono"
    - path: "discord-bridge/src/index.ts"
      provides: "Hono server with message proxy endpoint"
      exports: []
    - path: "discord-bridge/src/discord-client.ts"
      provides: "Discord REST API wrapper with caching and rate limit handling"
      exports: ["fetchChannelMessages"]
    - path: "lens-editor/vite.config.ts"
      provides: "Proxy route /api/discord -> sidecar"
      contains: "/api/discord"
  key_links:
    - from: "discord-bridge/src/index.ts"
      to: "discord-bridge/src/discord-client.ts"
      via: "import fetchChannelMessages"
      pattern: "fetchChannelMessages"
    - from: "discord-bridge/src/discord-client.ts"
      to: "https://discord.com/api/v10"
      via: "fetch with Bot token authorization header"
      pattern: "discord\\.com/api/v10"
    - from: "lens-editor/vite.config.ts"
      to: "discord-bridge (localhost:8091)"
      via: "Vite proxy rewrite rule"
      pattern: "/api/discord"
---

<objective>
Create the Discord bridge sidecar proxy service and configure Vite to proxy requests to it.

Purpose: The sidecar keeps the Discord bot token server-side (never exposed to browser) and provides a clean REST API for the frontend to fetch channel messages. The Vite proxy eliminates CORS in development.

Output: A working `discord-bridge/` Node.js service with Hono that proxies Discord "Get Channel Messages" requests, plus Vite proxy configuration.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bridge-history-display/01-RESEARCH.md
@lens-editor/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discord-bridge sidecar project with Hono proxy</name>
  <files>
    discord-bridge/package.json
    discord-bridge/tsconfig.json
    discord-bridge/src/types.ts
    discord-bridge/src/discord-client.ts
    discord-bridge/src/index.ts
  </files>
  <action>
    1. Create the `discord-bridge/` directory at the project root (sibling to `lens-editor/`).

    2. Initialize the project:
       ```bash
       cd discord-bridge && npm init -y
       npm install hono @hono/node-server
       npm install -D tsx typescript @types/node
       ```
       Update package.json: set `"type": "module"`, add scripts:
       ```json
       {
         "scripts": {
           "dev": "tsx watch src/index.ts",
           "start": "tsx src/index.ts"
         }
       }
       ```

    3. Create `tsconfig.json`:
       ```json
       {
         "compilerOptions": {
           "target": "ES2022",
           "module": "ESNext",
           "moduleResolution": "bundler",
           "strict": true,
           "esModuleInterop": true,
           "skipLibCheck": true,
           "outDir": "dist",
           "rootDir": "src"
         },
         "include": ["src"]
       }
       ```

    4. Create `src/types.ts`:
       Define TypeScript interfaces for the Discord message objects we care about (only the fields we use, not the full Discord API types). This avoids pulling in `discord-api-types` which is large. Define:
       - `DiscordUser`: `id`, `username`, `global_name` (nullable), `avatar` (nullable)
       - `DiscordMessage`: `id`, `content`, `author` (DiscordUser), `timestamp` (ISO8601 string), `type` (number)
       - `DiscordChannel`: `id`, `name`, `type` (number)
       - Export all types.

    5. Create `src/discord-client.ts`:
       - Export `fetchChannelMessages(channelId: string, limit?: number): Promise<DiscordMessage[]>`
       - Read `DISCORD_BOT_TOKEN` from `process.env` at call time (not module load)
       - Throw descriptive error if token is missing
       - Call `https://discord.com/api/v10/channels/${channelId}/messages?limit=${limit}` with `Authorization: Bot ${token}`
       - Handle 429 (rate limited): log warning with retry-after, throw error with retry info
       - Handle non-OK responses: throw with status code and response body
       - Implement simple in-memory cache: `Map<string, { data: DiscordMessage[], expiresAt: number }>` with 60-second TTL per channelId
       - On cache hit (not expired), return cached data without hitting Discord API
       - Export `fetchChannelInfo(channelId: string): Promise<DiscordChannel>` for getting channel name (GET /channels/:channelId) with same auth pattern and 5-minute cache TTL

    6. Create `src/index.ts`:
       - Import `serve` from `@hono/node-server`, `Hono` from `hono`, `cors` from `hono/cors`
       - Create Hono app
       - Add CORS middleware on `/api/*` (needed for production; Vite proxy handles dev)
       - Add health check: `GET /health` returns `{ status: "ok" }`
       - Add `GET /api/channels/:channelId/messages` endpoint:
         - Extract `channelId` from params, `limit` from query (default "50", max "100")
         - Call `fetchChannelMessages(channelId, parsedLimit)`
         - Return JSON array of messages
         - Catch errors: if rate-limited return 429 with `retryAfter`, if Discord error forward status, if token missing return 500 with clear message
       - Add `GET /api/channels/:channelId` endpoint:
         - Call `fetchChannelInfo(channelId)`
         - Return channel info JSON
       - Port: read from `DISCORD_BRIDGE_PORT` env var, default to 8091.
         Apply workspace convention: detect workspace from cwd (`ws1`=8091, `ws2`=8191).
         ```typescript
         const cwdMatch = process.cwd().match(/ws(\d+)/);
         const wsNum = cwdMatch ? parseInt(cwdMatch[1], 10) : 1;
         const defaultPort = 8091 + (wsNum - 1) * 100;
         const port = parseInt(process.env.DISCORD_BRIDGE_PORT || String(defaultPort), 10);
         ```
       - Log startup: `[discord-bridge] Listening on port ${port}`
       - Log each request: method, path, status (use Hono's built-in logger middleware: `import { logger } from 'hono/logger'`)
  </action>
  <verify>
    ```bash
    # Check TypeScript compiles
    cd discord-bridge && npx tsc --noEmit

    # Start the server briefly to verify it boots (will fail on missing token, but should start)
    cd discord-bridge && timeout 3 npx tsx src/index.ts 2>&1 || true
    # Should see "Listening on port 8091" in output (may also see token warning)
    ```
  </verify>
  <done>discord-bridge project exists with package.json, tsconfig.json, and three source files. TypeScript compiles without errors. Server starts and logs its port.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vite proxy for discord-bridge and add npm scripts</name>
  <files>
    lens-editor/vite.config.ts
    lens-editor/package.json
  </files>
  <action>
    1. Update `lens-editor/vite.config.ts` to add a proxy rule for the discord bridge:
       - Add port calculation for discord bridge: `const defaultBridgePort = 8091 + portOffset;`
       - Read bridge port from env: `const bridgePort = parseInt(process.env.DISCORD_BRIDGE_PORT || String(defaultBridgePort), 10);`
       - Add proxy entry after the existing `/api/relay` entry:
         ```typescript
         '/api/discord': {
           target: `http://localhost:${bridgePort}`,
           changeOrigin: true,
           rewrite: (path) => path.replace(/^\/api\/discord/, '/api'),
         },
         ```
       - Add log line: `console.log(\`[vite] Discord bridge port ${bridgePort}\`);`

    2. Add npm scripts to `lens-editor/package.json` for convenience:
       ```json
       "discord:start": "cd ../discord-bridge && npm run dev",
       "discord:setup": "echo 'Set DISCORD_BOT_TOKEN env var and run npm run discord:start'"
       ```
  </action>
  <verify>
    ```bash
    # Verify vite config has the proxy
    grep -n "api/discord" lens-editor/vite.config.ts

    # Verify npm scripts exist
    grep "discord:start" lens-editor/package.json
    ```
  </verify>
  <done>Vite proxy forwards /api/discord/* to the sidecar. lens-editor has convenience scripts for starting the bridge.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Discord bridge sidecar proxy service at `discord-bridge/` and Vite proxy configuration.

    The sidecar:
    - Runs on port 8091 (ws1) / 8191 (ws2)
    - Proxies GET /api/channels/:channelId/messages to Discord REST API
    - Proxies GET /api/channels/:channelId for channel info
    - Caches responses for 60s (messages) / 5min (channel info)
    - Handles rate limits and errors gracefully
    - Never exposes bot token to browser

    Vite proxies /api/discord/* to the sidecar in development.
  </what-built>
  <how-to-verify>
    1. Set your Discord bot token:
       ```bash
       export DISCORD_BOT_TOKEN="your-bot-token-here"
       ```

    2. Start the sidecar:
       ```bash
       cd discord-bridge && npm run dev
       ```
       Expected: Logs "Listening on port 8091"

    3. Test the health endpoint:
       ```bash
       curl http://localhost:8091/health
       ```
       Expected: `{"status":"ok"}`

    4. Test fetching messages from a known channel (use a channel ID from your Discord server):
       ```bash
       curl http://localhost:8091/api/channels/YOUR_CHANNEL_ID/messages?limit=5
       ```
       Expected: JSON array of Discord messages with id, content, author, timestamp fields

    5. Test channel info:
       ```bash
       curl http://localhost:8091/api/channels/YOUR_CHANNEL_ID
       ```
       Expected: JSON with channel id and name

    6. Verify Vite proxy works (with Vite dev server running):
       ```bash
       curl http://localhost:5173/api/discord/channels/YOUR_CHANNEL_ID/messages?limit=2
       ```
       Expected: Same response as step 4 (proxied through Vite)
  </how-to-verify>
  <resume-signal>Type "approved" if the bridge returns real Discord messages, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
cd discord-bridge && npx tsc --noEmit

# Vite config has proxy
grep "api/discord" lens-editor/vite.config.ts

# Sidecar starts (even without token, it should boot and log port)
cd discord-bridge && timeout 3 npx tsx src/index.ts 2>&1 | head -5

# Health endpoint works
curl -s http://localhost:8091/health
```
</verification>

<success_criteria>
- discord-bridge/ directory exists with package.json, tsconfig.json, and src/ files
- Server boots and listens on port 8091
- Health endpoint returns 200
- Messages endpoint returns Discord messages when bot token is set
- Vite proxy routes /api/discord/* to the sidecar
- Bot token exists only in sidecar process, never in browser-accessible config
</success_criteria>

<output>
After completion, create `.planning/phases/01-bridge-history-display/01-02-SUMMARY.md`
</output>
