---
phase: 05-search-ui
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - lens-editor/src/components/Sidebar/SearchInput.tsx
  - lens-editor/src/components/Sidebar/Sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "Typing 2+ characters in the search bar shows server-side full-text search results instead of the file tree"
    - "Clearing the search bar restores the file tree"
    - "Clicking a search result navigates to that document in the editor"
    - "Ctrl+K (or Cmd+K on Mac) focuses the search input from anywhere"
  artifacts:
    - path: "lens-editor/src/components/Sidebar/SearchInput.tsx"
      provides: "Ref-forwarded search input for Ctrl+K focus"
      exports: ["SearchInput"]
    - path: "lens-editor/src/components/Sidebar/Sidebar.tsx"
      provides: "Integrated sidebar with search panel toggle and keyboard shortcut"
      contains: "useSearch"
  key_links:
    - from: "lens-editor/src/components/Sidebar/Sidebar.tsx"
      to: "lens-editor/src/hooks/useSearch.ts"
      via: "import useSearch"
      pattern: "import.*useSearch"
    - from: "lens-editor/src/components/Sidebar/Sidebar.tsx"
      to: "lens-editor/src/components/Sidebar/SearchPanel.tsx"
      via: "import SearchPanel"
      pattern: "import.*SearchPanel"
    - from: "lens-editor/src/components/Sidebar/Sidebar.tsx"
      to: "lens-editor/src/components/Sidebar/SearchInput.tsx"
      via: "ref prop for Ctrl+K focus"
      pattern: "searchInputRef"
---

<objective>
Wire the search components into the sidebar: integrate SearchPanel into Sidebar.tsx, add ref forwarding to SearchInput for keyboard shortcut, and add Ctrl+K global shortcut. Verify the full search flow visually.

Purpose: This is the integration step -- connecting the tested building blocks from Plan 01 into the live UI.
Output: Working search UI in the sidebar that users can interact with.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-search-ui/05-RESEARCH.md
@.planning/phases/05-search-ui/05-01-SUMMARY.md

@lens-editor/src/components/Sidebar/Sidebar.tsx
@lens-editor/src/components/Sidebar/SearchInput.tsx
@lens-editor/src/components/Sidebar/SearchPanel.tsx (from Plan 01)
@lens-editor/src/hooks/useSearch.ts (from Plan 01)
@lens-editor/src/contexts/NavigationContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ref forwarding to SearchInput + integrate search into Sidebar</name>
  <files>
    lens-editor/src/components/Sidebar/SearchInput.tsx
    lens-editor/src/components/Sidebar/Sidebar.tsx
  </files>
  <action>
**Step 1: Update SearchInput to forward ref**

Modify `SearchInput.tsx` to use `forwardRef` so the parent can focus the input programmatically:

```typescript
import { forwardRef } from 'react';

interface SearchInputProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
}

export const SearchInput = forwardRef<HTMLInputElement, SearchInputProps>(
  function SearchInput({ value, onChange, placeholder = 'Search...' }, ref) {
    return (
      <div className="relative">
        {/* Search icon - same SVG as before */}
        ...
        <input
          ref={ref}
          type="text"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placeholder}
          className="..."
        />
        {/* Clear button - same as before */}
        ...
      </div>
    );
  }
);
```

Keep all existing JSX and styling. The only changes are:
1. Wrap with `forwardRef`
2. Add `ref` prop to the `<input>` element
3. Change default placeholder from `'Filter...'` to `'Search...'` (now does full-text search)

**Step 2: Integrate useSearch and SearchPanel into Sidebar**

Modify `Sidebar.tsx` to:

1. Import `useSearch` from `../../hooks/useSearch`
2. Import `SearchPanel` from `./SearchPanel`
3. Import `useNavigation` -- already imported, get `onNavigate` from it
4. Add `useRef<HTMLInputElement>(null)` for `searchInputRef`
5. Call `useSearch(searchTerm)` to get `{ results: searchResults, loading: searchLoading, error: searchError }`
6. Add `useEffect` for Ctrl+K / Cmd+K keyboard shortcut that focuses `searchInputRef.current`
7. Pass `ref={searchInputRef}` to `<SearchInput>`
8. In the tree content div, conditionally render:
   - If `searchTerm.trim().length >= 2`: render `<SearchPanel results={searchResults} loading={searchLoading} error={searchError} query={searchTerm} onNavigate={onNavigate} />`
   - Otherwise: render existing FileTree content (unchanged)

The existing `deferredSearch` / `useDeferredValue` / `filterTree` / `filteredTree` logic stays for when search term is 0-1 chars (shows filtered file tree). When search term is 2+ chars, the SearchPanel takes over with server-side results.

**Important:** Keep the existing FileTree rendering code intact. The only change to the tree section is wrapping it in a conditional: `{searchTerm.trim().length >= 2 ? <SearchPanel .../> : <existing tree content>}`.

**Ctrl+K handler:**
```typescript
const searchInputRef = useRef<HTMLInputElement>(null);

useEffect(() => {
  const handler = (e: KeyboardEvent) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      searchInputRef.current?.focus();
    }
  };
  document.addEventListener('keydown', handler);
  return () => document.removeEventListener('keydown', handler);
}, []);
```

**Navigation handler for search results** -- use `onNavigate` from `useNavigation()` (already available in Sidebar via the `onSelectDocument` prop pattern, but `onNavigate` from the context is the direct way; both call `setActiveDocId` in App.tsx). Use `onSelectDocument` since it's already a prop, OR use `onNavigate` from NavigationContext. The Sidebar already imports `useNavigation` on line 6 and destructures `metadata, folderDocs, folderNames` on line 32. Just add `onNavigate` to the destructure.
  </action>
  <verify>
    cd lens-editor && npx vitest run src/components/Sidebar/Sidebar.test.tsx
    cd lens-editor && npx vitest run
  </verify>
  <done>
    Sidebar renders SearchPanel when search term is 2+ characters. File tree shows when search term is empty or 1 character. SearchInput accepts ref for programmatic focus. Ctrl+K focuses the search input. All existing tests still pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full search UI: search bar in sidebar with full-text search, results with highlighted snippets, click-to-navigate, Ctrl+K keyboard shortcut</what-built>
  <how-to-verify>
1. Start the local relay server if not running:
   ```bash
   cd lens-editor && npm run relay:start
   ```
   Then in another terminal:
   ```bash
   cd lens-editor && npm run relay:setup
   ```
2. Start the dev server:
   ```bash
   cd lens-editor && npm run dev:local
   ```
3. Open in browser: http://dev.vps:5373 (or the port shown in terminal)
4. **Search bar:** The sidebar should show a search input with "Search..." placeholder
5. **Type a query:** Type "welcome" (or any term from your test docs) -- after 2+ characters, the file tree should be replaced by search results
6. **Results format:** Each result should show: document title, folder name, and a text snippet with highlighted matching terms (yellow background on matched words)
7. **Click navigation:** Click on a search result -- the editor should open that document
8. **Clear search:** Click the X button or clear the input -- the file tree should reappear
9. **Keyboard shortcut:** Click somewhere in the editor area, then press Ctrl+K -- the search input should gain focus
10. **Empty/short query:** Type just 1 character -- should still show file tree (client-side filter), not search results
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
All existing tests pass:
```bash
cd lens-editor && npx vitest run
```

Manual verification:
- Search bar visible in sidebar
- Full-text search results appear for 2+ character queries
- Results show title, folder, snippet with highlights
- Click navigates to document
- Ctrl+K focuses search input
- Clearing search restores file tree
</verification>

<success_criteria>
- SearchInput forwards ref for programmatic focus
- Sidebar toggles between FileTree and SearchPanel based on query length (< 2 chars = tree, >= 2 chars = search)
- Ctrl+K / Cmd+K focuses the search input from anywhere
- Search results use onNavigate to open documents
- Existing sidebar functionality (file tree, CRUD, context menus) unaffected
- Human has verified the full search flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/05-search-ui/05-02-SUMMARY.md`
</output>
