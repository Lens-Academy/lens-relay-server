# Milestone v1.0: Search & MCP MVP

**Status:** SHIPPED 2026-02-11
**Phases:** 1-5
**Total Plans:** 10

## Overview

This roadmap delivers full-text keyword search and MCP-based AI assistant integration for the Lens Relay knowledge base. The work splits naturally into five phases: building the search index foundation, establishing the custom MCP transport layer, implementing read-only MCP tools, adding search and edit capabilities, and delivering the search UI in lens-editor. The search index and MCP transport are independent foundations that can be built in parallel; everything else flows from them.

## Phases

### Phase 1: Search Index

**Goal**: Users and services can search across all Lens and Lens Edu documents via an HTTP API, with results ranked by relevance and including text snippets
**Depends on**: Nothing (foundation)
**Requirements**: SRCH-01, SRCH-02, SRCH-03, SRCH-04, SRCH-05, SRCH-06
**Plans**: 2 plans

Plans:
- [x] 01-01-PLAN.md -- SearchIndex core module (TDD: schema, indexing, search, snippets)
- [x] 01-02-PLAN.md -- Server integration + HTTP search endpoint

**Details:**
- tantivy 0.25 with MmapDirectory (production) / RamDirectory (tests)
- 4-field schema: doc_id (STRING), title (TEXT, 2x boost), body (TEXT), folder (STORED)
- BM25 ranking with AND conjunction, lenient parsing
- Custom `<mark>` snippet rendering
- Startup reindex + debounced live updates via mpsc channel worker
- GET /search?q=&limit= endpoint with 503 gate during initial indexing

### Phase 2: MCP Transport

**Goal**: AI assistants can connect to the relay server's /mcp endpoint and exchange JSON-RPC messages over Streamable HTTP with proper session tracking
**Depends on**: Nothing (can be built in parallel with Phase 1)
**Requirements**: MCP-01, MCP-02, MCP-03
**Plans**: 2 plans

Plans:
- [x] 02-01-PLAN.md -- MCP protocol engine (TDD: JSON-RPC types, sessions, method dispatch)
- [x] 02-02-PLAN.md -- HTTP transport handler + server integration + live verification

**Details:**
- JSON-RPC 2.0 parsing by id field presence (not serde untagged)
- DashMap-backed SessionManager with 32-char nanoid IDs
- Method dispatch: initialize, ping, tools/list, tools/call
- POST/GET/DELETE /mcp handlers with correct HTTP status codes
- Session validation: initialized required for tools/call only

### Phase 3: MCP Read-Only Tools

**Goal**: AI assistants can discover, read, and navigate links between documents in the knowledge base via MCP tools
**Depends on**: Phase 2
**Requirements**: MCP-05, MCP-06, MCP-08
**Plans**: 2 plans

Plans:
- [x] 03-01-PLAN.md -- DocumentResolver: bidirectional path-UUID cache (TDD)
- [x] 03-02-PLAN.md -- Tool implementations (read, glob, get_links) + router wiring + server integration

**Details:**
- DocumentResolver with bidirectional DashMap (path<->UUID)
- derive_folder_name() centralizing "Lens"/"Lens Edu" naming
- read tool: cat -n format with offset/limit
- glob tool: glob-match crate for pattern matching
- get_links tool: backlinks_v0 Y.Map + forward wikilink extraction
- Lazy resolver rebuild for in-memory mode
- Router dispatch_request takes &Arc<Server> for tool access

### Phase 4: MCP Search & Edit Tools

**Goal**: AI assistants can find documents by keyword search and propose edits as reviewable CriticMarkup suggestions
**Depends on**: Phase 1 (search index), Phase 3 (tool infrastructure)
**Requirements**: MCP-04, MCP-07, MCP-09
**Plans**: 2 plans

Plans:
- [x] 04-01-PLAN.md -- Grep tool (regex content search) + session read-tracking infrastructure (TDD)
- [x] 04-02-PLAN.md -- Edit tool with CriticMarkup wrapping and read-before-edit enforcement (TDD)

**Details:**
- grep: regex crate on Y.Doc text, ripgrep-format output, context lines, output modes
- edit: CriticMarkup {--old--}{++new++} wrapping, TOCTOU re-verify
- session_id threaded through dispatch chain
- read_docs HashSet for read-before-edit enforcement
- No replace_all for v1 (single unique match required)

### Phase 5: Search UI

**Goal**: Users of lens-editor can search across all documents and navigate to results without leaving the editor
**Depends on**: Phase 1 (search API)
**Requirements**: UI-01, UI-02, UI-03
**Plans**: 2 plans

Plans:
- [x] 05-01-PLAN.md -- Search API client, useSearch hook (TDD), SearchPanel component
- [x] 05-02-PLAN.md -- Sidebar integration, SearchInput ref forwarding, Ctrl+K shortcut, visual verification

**Details:**
- searchDocuments() API client in relay-api.ts
- useSearch hook: 300ms debounce, AbortController, 2-char minimum
- SearchPanel: dangerouslySetInnerHTML for `<mark>` snippets
- Sidebar integration with conditional SearchPanel vs FileTree
- Ctrl+K keyboard shortcut

---

## Milestone Summary

**Key Decisions:**

- CriticMarkup for MCP edits (no custom AuthZ yet; suggestions are safe)
- Keyword search only, no semantic (tight scope)
- Search index as shared service (lens-editor + MCP)
- MCP embedded in relay (/mcp endpoint, URL-based setup)
- Custom MCP transport, no rmcp (5 tools, control over session state)
- Read-before-edit enforcement (mirrors Claude Code's Edit tool pattern)
- Grep uses regex on Y.Docs directly (not SearchIndex/tantivy)
- JSON-RPC Request vs Notification by id field presence
- Protocol version always 2025-03-26
- TOCTOU re-verify in write transactions

**Issues Resolved:**

- tantivy 0.25 API differences from research notes (try_open â†’ try_into)
- DashMap iteration order nondeterminism (sorted folder_doc_ids for deterministic naming)
- Lazy resolver rebuild for in-memory mode
- Forward link resolution via case-insensitive basename matching

**Issues Deferred:**

- SSE transport (GET /mcp returns 405)
- Forward link path-component matching (basename only in v1)
- Human verification: MCP client end-to-end test
- Human verification: concurrent session isolation

**Technical Debt Incurred:**

- 5 pre-existing integration test failures in lens-editor (require running relay server)
- GET /mcp SSE stub returns 405

---

_For current project status, see .planning/PROJECT.md_
